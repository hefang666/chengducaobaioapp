<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>异常类型_换表</title>
    <link rel="stylesheet" type="text/css" href="../../../public/css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/aui1.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/dialog.css" />
    <style>
        body {
            height: 100%;
            width: 100%;
            display: flex;
            flex-flow: column;
            background-color: #F3F3F3;
        }

        #center {
            flex: 1;
            overflow: scroll;
            background-color: #F4F4F4;
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 10px;
            border-radius: 15px;
            background-color: #ffffff;
            padding: 20px;
            -webkit-overflow-scrolling: touch; //移动端滑动流畅设置。
        }

        #footer {
            height: 60px;
            background-color: #ffffff;
            width: 100%;
            display: flex;
            flex-direction: row;
        }

        #footer div {
            float: left;
            flex: 1;
            text-align: center;
            line-height: 40px;
        }

        #baocun {
            width: 100px;
            height: 35px;
            background-color: #2F87F8;
            color: #fff;
            border-radius: 20px;
            font-size: 15px;
        }

        #shangchuan {
            width: 100px;
            height: 35px;
            background-color: #FF4141;
            color: #fff;
            border-radius: 20px;
            font-size: 15px;
        }

        .center_dv {
            height: 30px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: row;
        }

        .dv_one {
            font-size: 18px;
            line-height: 30px;
        }

        .dv_two {
            flex: 1;
            color: #626262;
            margin-left: 10px;
            font-size: 18px;
            line-height: 30px;
            overflow: scroll;
            flex-direction: row;
            white-space: nowrap;
        }

        .font {
            border-bottom: 1px solid #D8D8D8;
        }

        .text {
            height: 3px;
            border-radius: 10px;
            background-color: #DEDEDE;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .select_dv {
            display: flex;
            flex-direction: row;
        }

        .center_dv2 {
            flex: 1;
            color: #626262;
        }

        .textarea {
            border: 1px solid #D9D9D9;
            border-radius: 15px;
            font-size: 18px;
            color: #626262;
            width: 100%;
            height: 100px;
            padding: 10px;
        }

        #DZ {
            color: #377EFF;
        }

        .display {
            display: none;
        }
    </style>
</head>

<body>
    <div id="center">
        <div class="center_dv">
            <div class="dv_one">户&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号</div>
            <div class="dv_two font" id="YHBH"></div>
        </div>
        <div class="center_dv">
            <div class="dv_one">户&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</div>
            <div class="dv_two" id="YHMC"></div>
        </div>
        <div class="center_dv">
            <div class="dv_one">用户地址</div>
            <div class="dv_two" id="YHDZ"></div>
        </div>
        <div class="center_dv">
            <div class="dv_one">水表位置</div>
            <div class="dv_two" id="SBWZ"></div>
        </div>
        <div class="center_dv">
            <div class="dv_one">用水性质</div>
            <div class="dv_two" id="YSXZ"></div>
        </div>
        <div class="center_dv">
            <div class="dv_one">口&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;径</div>
            <div class="dv_two" id="KJ"></div>
        </div>

        <div class="text"></div>

        <div class="center_dv">
            <div class="dv_one">反映区名</div>
            <div class="dv_two font select_dv">
                <div class="center_dv2" onclick="select(1)" id="FYQMNAME"></div>
                <div class="center_dv3" onclick="select(1)"><i class="aui-iconfont aui-icon-down"></i></div>
            </div>
        </div>
        <div class="center_dv" style="display:none;">
            <div class="dv_one">信息来源</div>
            <div class="dv_two font select_dv">
                <div class="center_dv2" onclick="select(2)" id="XXLYNAME"></div>
                <div class="center_dv3" onclick="select(2)"><i class="aui-iconfont aui-icon-down"></i></div>
            </div>
        </div>
        <div class="center_dv">
            <div class="dv_one">问题原因</div>
            <div class="dv_two font select_dv">
                <div class="center_dv2" onclick="select(3)" id="WTYYNAME"></div>
                <div class="center_dv3" onclick="select(3)"><i class="aui-iconfont aui-icon-down"></i></div>
            </div>
        </div>
        <div class="center_dv">
            <div class="dv_one">
                <img src="../../image/MeteReading/tupian/dingwei.png" class="image" />
            </div>
            <div class="dv_two" id="DZ">重庆市渝中区上清寺9号</div>
        </div>
        <div class="center_dv">
            <div class="dv_one display" id="SQMSDIV">申请描述</div>
        </div>
        <textarea class="textarea display" placeholder="请输入内容" id="SQMS"></textarea>

    </div>

    <div id="footer">
        <div><button id="baocun" onclick="baocun()">保存</button></div>
        <div><button id="shangchuan" onclick="shangchuan()">提交</button></div>
    </div>
</body>
<script type="text/javascript" src="../../../public/script/api.js"></script>
<script type="text/javascript" src="../../script/cbpublic.js"></script>
<script type="text/javascript" src="../../script/cbremote.js"></script>
<script type="text/javascript" src="../../../public/script/aui-popup-new.js"></script>
<script type="text/javascript" src="../../../public/script/aui-slide.js"></script>
<script type="text/javascript" src="../../../public/script/swiper.min.js"></script>
<script type="text/javascript" src="../../../public/script/diy/template.js"></script>
<script type="text/javascript" src="../../../public/script/zepto.js"></script>

<script type="text/javascript" src="../../../public/script/common.js"></script>
<script type="text/javascript" src="../../../public/script/hammer.min.js"></script>
<script type="text/javascript" src="../../../public/script/aui-dialog.js"></script>
<script type="text/javascript">
    var userbean; //用户数据
    var workorderbean; //工单数据

    var onlineFYQMID = []; //反映区名ID数据。
    var onlineFYQMNAME = []; //反映区名NAME数据。

    var onlineXXLYID = []; //信息来源ID数据。
    var onlineXXLYNAME = []; //信息来源NAME数据。

    var onlineWTYYID = []; //问题原因ID数据。
    var onlineWTYYNAME = []; //问题原因NAME数据。

    var FYQMID = "";
    var FYQMNAME = "";
    var XXLYID = "";
    var XXLYNAME = "";
    var WTYYID = "";
    var WTYYNAME = "";

    var workordertype = 0;
    var lon = ""; //经度
    var lat = ""; //维度
    var address = ""; //地址
    apiready = function() {
        //api.parseTapmode();

        queryFYQM();
        map();
        queryData();
    };

    function queryFYQM() {
        var Parameter = {

        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "MMS102",
                "Parameter": "1"
            })
        };
        console.log(body.body);
        fnPost('', body, 'application/json', false, function(ret, err) {
            console.log(JSON.stringify(ret));
            if (ret) {
                if (ret.Status == 0) {
                    var Data = [];
                    if (ret.Data != "" && ret.Data != " ") {
                        Data = JSON.parse(ret.Data);
                    }
                    //var Data = JSON.parse(ret.Data);
                    if (Data.length > 0) {
                        for (var i = 0; i < Data.length; i++) {
                            onlineFYQMID.push(Data[i].Id);
                            onlineFYQMNAME.push(Data[i].Name);
                        }
                    }
                } else {
                    api.toast({
                        msg: ret.Message,
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
            queryXXLY();
        });

    }

    function queryXXLY() {
        var Parameter = {
            "TypeId": "RPTXXLY",
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "MMS103",
                "Parameter": JSON.stringify(Parameter)
            })
        };
        console.log(body.body);
        fnPost('', body, 'application/json', false, function(ret, err) {
            console.log(JSON.stringify(ret));
            if (ret) {
                if (ret.Status == 0) {
                    var Data = [];
                    if (ret.Data != "" && ret.Data != " ") {
                        Data = JSON.parse(ret.Data);
                    }
                    //var Data = JSON.parse(ret.Data);
                    if (Data.length > 0) {
                        for (var i = 0; i < Data.length; i++) {
                            onlineXXLYID.push(Data[i].Id);
                            onlineXXLYNAME.push(Data[i].Name);
                        }
                    }

                } else {
                    api.toast({
                        msg: ret.Message,
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
            queryWTYY();
        });
    }

    function queryWTYY() {
        var Parameter = {
            "TypeId": "RPTHBYY",
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "MMS103",
                "Parameter": JSON.stringify(Parameter)
            })
        };
        console.log(body.body);
        fnPost('', body, 'application/json', false, function(ret, err) {
            console.log(JSON.stringify(ret));
            if (ret) {
                if (ret.Status == 0) {
                    var Data = [];
                    if (ret.Data != "" && ret.Data != " ") {
                        Data = JSON.parse(ret.Data);
                    }
                    //var Data = JSON.parse(ret.Data);
                    if (Data.length > 0) {
                        for (var i = 0; i < Data.length; i++) {
                            onlineWTYYID.push(Data[i].Id);
                            onlineWTYYNAME.push(Data[i].Name);
                        }
                    }

                } else {
                    api.toast({
                        msg: ret.Message,
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        });
    }

    function queryData() {
        var db = api.require('db');

        //获取用户数据
        var userdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_USER_BEAN where YHBH="' + api.pageParam.YHBH + '"'
        });
        if (userdata.data) {
            if (userdata.data.length > 0) {
                userbean = userdata.data[0];

                $('#YHBH').html(userbean.YHBH);
                $('#YHMC').html(userbean.YHMC);
                $('#YHDZ').html(userbean.YHDZ);
                $('#SBWZ').html(userbean.SBWZ);
                $('#YSXZ').html(userbean.YSXZ);
                $('#KJ').html(userbean.KJ);
            }
        }

        //获取工单数据
        var workorderdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_WORKORDER_BEAN where YHBH="' + api.pageParam.YHBH + '"'
        });
        if (workorderdata.data) {
            if (workorderdata.data.length > 0) {
                if (api.pageParam.YCLXID == workorderdata.data[0].YCLXID) {
                    workorderbean = workorderdata.data[0];
                    workordertype = 1;

                    $('#FYQMNAME').html(workorderbean.FYQMNAME);
                    $('#XXLYNAME').html(workorderbean.XXLYNAME);
                    $('#WTYYNAME').html(workorderbean.WTYYNAME);
                    $('#SQMS').val(workorderbean.SQMS);

                    FYQMID = workorderbean.FYQMID;
                    FYQMNAME = workorderbean.FYQMNAME;
                    XXLYID = workorderbean.XXLYID;
                    XXLYNAME = workorderbean.XXLYNAME;
                    WTYYID = workorderbean.WTYYID;
                    WTYYNAME = workorderbean.WTYYNAME;
                } else {
                    workordertype = 0;
                    var ret = db.executeSqlSync({
                        name: 'CBtest',
                        sql: 'delete from MRM_WORKORDER_BEAN where YHBH="' + api.pageParam.YHBH + '"'
                    });
                    var querybookdata = db.selectSqlSync({
                        name: 'CBtest',
                        sql: 'select * from MRM_BOOKS_BEAN where CBCH="' + userbean.CBCH + '"'
                    });
                    var GDSBS = parseInt(querybookdata.data[0].GDSBS);
                    var updatebookData = db.executeSqlSync({
                        name: 'CBtest',
                        sql: 'update MRM_BOOKS_BEAN set GDSBS=' + (GDSBS - 1) + ' where CBCH="' + userbean.CBCH + '"'
                    });
                }

                if (workorderbean.SFSC == "1") {
                    $('.select_dv').attr('disabled', 'disabled');
                    $('#GDBH').attr('disabled', 'disabled');
                    $('#KHDH').attr('disabled', 'disabled');
                    $('#YYMS').attr('disabled', 'disabled');

                    document.getElementById("footer").style.display = "none"; //隐藏
                }
            } else {
                workordertype = 0;
            }
        }

    }

    function select(index) {
        if (workordertype == 1 && workorderbean.SFSC == "1") {
            return;
        }
        if (index == 1) {
            //反映区名
            api.actionSheet({
                buttons: onlineFYQMNAME
            }, function(ret, err) {
                var index = ret.buttonIndex;
                if (index <= onlineFYQMID.length) {
                    $('#FYQMNAME').html(onlineFYQMNAME[index - 1]);
                    FYQMID = onlineFYQMID[index - 1]
                    FYQMNAME = onlineFYQMNAME[index - 1]
                }
            });
        } else if (index == 2) {
            //信息来源
            api.actionSheet({
                buttons: onlineXXLYNAME
            }, function(ret, err) {
                var index = ret.buttonIndex;
                if (index <= onlineXXLYID.length) {
                    $('#XXLYNAME').html(onlineXXLYNAME[index - 1]);
                    XXLYID = onlineXXLYID[index - 1]
                    XXLYNAME = onlineXXLYNAME[index - 1]
                }
            });
        } else if (index == 3) {
            //问题原因
            api.actionSheet({
                buttons: onlineWTYYNAME
            }, function(ret, err) {
                var index = ret.buttonIndex;
                if (index <= onlineWTYYID.length) {
                    $('#WTYYNAME').html(onlineWTYYNAME[index - 1]);
                    WTYYID = onlineWTYYID[index - 1]
                    WTYYNAME = onlineWTYYNAME[index - 1]
                    if (WTYYNAME == "其他原因") {
                        $('#SQMSDIV').removeClass("display");
                        $('#SQMS').removeClass("display");
                    } else {
                        $('#SQMSDIV').addClass("display");
                        $('#SQMS').addClass("display");
                    }
                }
            });
        }
    }

    //定位
    function map() {
        lon = ""; //经度
        lat = ""; //维度
        address = ""; //地址

        var bMap = api.require('bMap');
        bMap.getLocation({
            accuracy: '100m',
            autoStop: true,
            filter: 1
        }, function(ret, err) {
            if (ret.status) {
                lon = ret.lon;
                lat = ret.lat;
                bMap.getNameFromCoords({
                    lon: lon,
                    lat: lat
                }, function(ret, err) {
                    if (ret.status) {
                        address = ret.address;
                        $('#DZ').html(address);
                    } else {

                    }
                });
            } else {

            }
        });
    }

    //保存
    function baocun() {
        var FYQMNAME = $('#FYQMNAME').html();
        //var XXLYNAME = $('#XXLYNAME').html();
        var WTYYNAME = $('#WTYYNAME').html();
        var SQMS = $('#SQMS').val();

        if (FYQMNAME == "" || WTYYNAME == "") {
            api.toast({
                msg: '请录入完整信息',
                duration: 2000,
                location: 'bottom'
            });
        } else {
            var db = api.require('db');
            var date = new Date(); //实例一个时间对象；
            var year = Time("year"); //获取系统的年；
            var month = Time("month"); //获取系统月份，由于月份是从0开始计算，所以要加1
            var day = Time("day"); //获取系统日
            var time = year + "-" + month + "-" + day
            if (workordertype == 0) {
                //新增工单
                var sql = "INSERT INTO MRM_WORKORDER_BEAN (YHBH, YHMC, YHDZ, QD, ZD, JLSJ, SFSC, " +
                    "YCLXID, YCLXNAME, FYQMID, FYQMNAME, XXLYID, XXLYNAME, WTYYID, WTYYNAME, SQMS, JD, WD, DZ) VALUES " +
                    "('" + userbean.YHBH +
                    "', '" + userbean.YHMC +
                    "', '" + userbean.YHDZ +
                    "', '" + userbean.QD +
                    "', '" + userbean.ZD +
                    "', '" + time +
                    "', '0', '" + api.pageParam.YCLXID +
                    "', '" + api.pageParam.YCLXNAME +
                    "', '" + FYQMID +
                    "', '" + FYQMNAME +
                    "', '" + XXLYID +
                    "', '" + XXLYNAME +
                    "', '" + WTYYID +
                    "', '" + WTYYNAME +
                    "', '" + SQMS +
                    "', '" + lon +
                    "', '" + lat +
                    "', '" + address + "')"
                console.log(sql);
                var workOrderData = db.executeSqlSync({
                    name: 'CBtest',
                    sql: sql
                });
                if (workOrderData.status) {
                    api.toast({
                        msg: '保存成功',
                        duration: 3000,
                        location: 'bottom'
                    });
                    workordertype = 1;
                    var querybookdata = db.selectSqlSync({
                        name: 'CBtest',
                        sql: 'select * from MRM_BOOKS_BEAN where CBCH="' + userbean.CBCH + '"'
                    });
                    var GDSBS = parseInt(querybookdata.data[0].GDSBS);
                    var updatebookData = db.executeSqlSync({
                        name: 'CBtest',
                        sql: 'update MRM_BOOKS_BEAN set GDSBS=' + (GDSBS + 1) + ' where CBCH="' + userbean.CBCH + '"'
                    });
                    queryData();
                    var jsfun = 'show();';
                    api.execScript({
                        name: "workOrder",
                        script: jsfun
                    });
                }
            } else {
                //修改工单
                var sql = 'update MRM_WORKORDER_BEAN set ' +
                    'YHMC="' + userbean.YHMC + '",' +
                    'YHDZ="' + userbean.YHDZ + '",' +
                    'QD="' + userbean.QD + '",' +
                    'ZD="' + userbean.ZD + '",' +
                    'JLSJ="' + time + '",' +
                    'SFSC="0",' +
                    'YCLXID="' + api.pageParam.YCLXID + '",' +
                    'YCLXNAME="' + api.pageParam.YCLXNAME + '",' +
                    'FYQMID="' + FYQMID + '",' +
                    'FYQMNAME="' + FYQMNAME + '",' +
                    'XXLYID="' + XXLYID + '",' +
                    'XXLYNAME="' + XXLYNAME + '",' +
                    'WTYYID="' + WTYYID + '",' +
                    'WTYYNAME="' + WTYYNAME + '",' +
                    'SQMS="' + SQMS + '",' +
                    'JD="' + lon + '",' +
                    'WD="' + lat + '",' +
                    'DZ="' + address + '" where YHBH="' + userbean.YHBH + '"';
                var workOrderData = db.executeSqlSync({
                    name: 'CBtest',
                    sql: sql
                });
                if (workOrderData.status) {
                    api.toast({
                        msg: '修改成功',
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            }
        }
    }

    function shangchuan() {
        if (workordertype == 1) {
            if (workorderbean.SFSC == "1") {
                api.toast({
                    msg: '工单已提交',
                    duration: 3000,
                    location: 'bottom'
                });
                return;
            }
            var Parameter = {
                "TypeId": workorderbean.YCLXID,
                "CustomerCode": workorderbean.YHBH,
                "Moblie": $api.getStorage('cbOperatorMoblie'),
                "SourceId": workorderbean.XXLYID,
                "MeterRemark": workorderbean.WTYYID,
                "Areas": workorderbean.FYQMID,
                "Emergency": workorderbean.JJQKID,
                "ProcessingLevelId": workorderbean.CLJBID,
                "OrderNo": workorderbean.GDBH,
                "OrderTypeId": "",
                "Remark": workorderbean.BZ,
                "Longitude": workorderbean.JD,
                "Latitude": workorderbean.WD,
                "Address": workorderbean.DZ,
                "ClientId": api.deviceId,
                "ClientName": api.deviceModel
            };
            var body = {
                body: JSON.stringify({
                    "UserName": $api.getStorage('cbOperatorName'),
                    "Password": $api.getStorage('cbPassword'),
                    "SerialNo": dataTime(),
                    "Method": "MMS101",
                    "Parameter": JSON.stringify(Parameter)
                })
            };
            console.log(body.body);
            fnPost3('/webapi/request/postmms', body, 'application/json', false, function(ret, err) {
                console.log(JSON.stringify(ret));
                if (ret) {
                    if (ret.Status == 0) {
                        //上传成功
                        api.toast({
                            msg: '提交成功',
                            duration: 3000,
                            location: 'bottom'
                        });
                        workorderbean.SFSC = "1";

                        $('.select_dv').attr('disabled', 'disabled');
                        $('#SQMS').attr('disabled', 'disabled');

                        document.getElementById("footer").style.display = "none"; //隐藏

                        var Data;
                        if (ret.Data != "" && ret.Data != " ") {
                            Data = JSON.parse(ret.Data);
                        }
                        //var Data = JSON.parse(ret.Data);
                        var lcbh = "";
                        if (Data != null && Data != "") {
                            var DataId = Data.DataId;
                            var DataIds = DataId.split(",");
                            lcbh = DataIds[1];
                        }
                        var db = api.require('db');
                        var workOrderData = db.executeSqlSync({
                            name: 'CBtest',
                            sql: "update MRM_WORKORDER_BEAN set SFSC='1', LCBH='" + lcbh + "' where YHBH='" + workorderbean.YHBH + "'"
                        });
                    } else {
                        //上传失败
                        api.toast({
                            msg: ret.Message,
                            duration: 3000,
                            location: 'bottom'
                        });
                    }
                } else {
                    api.alert({
                        msg: JSON.stringify(err)
                    });
                }
            });
        } else {
            api.toast({
                msg: '请先保存数据',
                duration: 3000,
                location: 'bottom'
            });
        }
    }
</script>

</html>
