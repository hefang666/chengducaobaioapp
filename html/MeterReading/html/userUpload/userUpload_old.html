<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../../public/css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/aui1.css" />
    <link rel="stylesheet" type="text/css" href="../../../public/css/dialog.css" />
    <style>
        body {
            width: 100%;
            height: 100%;
            background-color: #ffffff;
        }
        .body_content{
          display: flex;
          flex-flow: column;
        }

        #header {
            position: fixed;
            top: 0;
            background: linear-gradient(90deg, rgba(46, 142, 250, 1), rgba(49, 89, 235, 1));
        }

        #center {
            flex: 1;
            overflow: scroll;
            background-color: #F4F4F4;
            margin-bottom: 100px;
            -webkit-overflow-scrolling: touch; //移动端滑动流畅设置。
        }

        #footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 100px;
            background-color: #ffffff;
        }

        .dv1 {
            width: 100%;
            height: 50px;
            border-bottom: 1px solid #F3F3FF;
            font-size: 0.8rem;
            padding-left: 8%;
            padding-right: 10%;
            margin-top: 20px;
        }

        .dv2 {
            margin-bottom: 20px;
        }

        .image {
            float: left;
            width: 10px;
            height: 10px;
            margin-top: 20px;
        }

        .sp {
            margin-top: 0.7rem;
            margin-left: 5px;
        }

        .sp-no {
            margin-top: 0.7rem;
            float: right;
            margin-right: 10px;
        }

        .aui-checkbox-1 {
            margin-top: 0.7rem;
            float: right;
        }

        .aui-checkbox {
            float: right;
        }

        .dv {
            width: 80%;
            height: 40px;
            display: flex;
            border-bottom: 1px solid #F3F3FF;
            margin-left: 10%;
        }

        .dv-1 {
            flex: 2;
            margin-top: 0.5rem;
        }

        .dv-2 {
            flex: 3;
            margin-top: 0.5rem;
            text-align: left;
            padding-left: 10px;
        }

        .dv-3 {
            flex: 3;
            margin-top: 0.5rem;
            text-align: left;
            padding-left: 10px;
        }

        .dv-4 {
            margin-top: 0.5rem;
        }

        .dv-5 {
            width: 1px;
            height: 16px;
            margin-top: 13px;
            background-color: #000;
        }

        .gundongBox {
            width: 300px;
            height: 30px;
            margin: 200px auto;
            position: relative;
            overflow: hidden;
            background: pink;
        }

        .gundongList {
            position: absolute;
            animation: geiwogun 12s linear infinite;
            white-space: nowrap;
        }

        @keyframes geiwogun {
            from {
                transform: translate(0, 0);
            }
            to {
                transform: translate(0, 0);
            }
        }

        #btn {
            width: 80%;
            height: 50px;
            margin-left: 10%;
            margin-top: 20px;
            border-radius: 20px;
            background-color: #377EFF;
            color: #fff;
            text-align: center;
            line-height: 50px;
            font-size: 18px;
        }

        .header_right {
            position: relative;
            float: right;
            width: 50px;
            height: 45px;
        }

        .image2 {
            position: absolute;
            width: 20px;
            height: 20px;
            margin-top: 15px;
        }

        .badge2 {
            position: absolute;
            height: 20px;
            margin-left: 10px;
            z-index: 10;
            background-color: #FF3024;
            border-radius: 10px;
            line-height: 20px;
        }

        .badge2 span {
            margin-left: 5px;
            margin-right: 5px;
        }

        .box {
            white-space: nowrap;
            overflow: hidden;
        }

        .content p {
            display: inline-block;
            font-size: 15px;
            color: #000000;
        }

        .content p.padding {
            padding-right: 50px;
        }

        .aui-list-item-arrow {
            color: #C2C2C2;
            font-size: 18px;
            height: 40px;
        }

        .center_dv {
            margin: 20px;
            border-radius: 20px;
            background-color: #ffffff;
            padding: 10px;
        }

        .center_dv1_span {
            margin-left: 5px;
            color: #2F7CF5;
            font-size: 18px;
        }

        .center_dv1_checkbox {
            float: right;
            margin-right: 10px;
        }

        .center_dv2 {
            height: 2px;
            background-color: #DEDEDE;
            margin-top: 10px;
        }

        .center_dv3 {
            margin-top: 10px;
        }

        .center_dv3_dv {
            background-color: #F4F4F4;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .dv_top {
            display: flex;
        }

        .dv_bottom {
            margin-top: 10px;
            display: flex;
        }

        .dv_top_dv1 {
            flex: 1;
            color: #000000;
            overflow: scroll;
            font-size: 18px;
            flex-direction: row;
            white-space: nowrap;
        }

        .dv_top_dv2 {}

        .dv_bottom_dv1 {
            flex: 1;
            text-align: left;
            flex-direction: row;
            white-space: nowrap;
            overflow: scroll;
            color: #6D6D6D;
        }

        .dv_bottom_dv2 {
            flex: 1;
            text-align: left;
            flex-direction: row;
            white-space: nowrap;
            overflow: scroll;
            color: #6D6D6D;
        }
    </style>
</head>

<body>
  <div class="body_content">
    <header class="aui-bar aui-bar-nav" id="header">
        <div class="aui-pull-left aui-btn" data-action='back'>
            <span class="aui-iconfont aui-icon-left"></span>
        </div>
        <div class="aui-title">数据上传</div>
    </header>

    <div id="center">
        <div class="aui-content mine_List">
            <ul class="aui-list">
                <li class="aui-list-item" onclick="errorUserList()">
                    <div class="aui-list-item-inner">
                        <div class="aui-list-item-inner aui-list-item-arrow">
                            失败列表
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="center_dv">
            <div class="center_dv1">
                <span class="center_dv1_span">抄表数据上传</span>
                <input type="checkbox" class="aui-checkbox center_dv1_checkbox" id="checkbox-1" onclick="setAllNo(1)" />
            </div>
            <div class="center_dv2"></div>
            <div class="center_dv3" id="books">
                <!--
                <div class="center_dv3_dv">
                    <div class="dv_top">
                        <div class="dv_top_dv1">
                            抄表本1
                        </div>
                        <div class="dv_top_dv2">
                            <input name="Fruit" type="checkbox" value="12345678" class="aui-checkbox" onclick="setOthers(1)" />
                        </div>
                    </div>

                    <div class="dv_bottom">
                        <div class="dv_bottom_dv1">已&nbsp;&nbsp;抄：1</div>
                        <div class="dv_bottom_dv2">未&nbsp;&nbsp;抄：3</div>
                    </div>
                </div>
-->
            </div>
        </div>

        <div class="center_dv">
            <div class="center_dv1">
                <span class="center_dv1_span">其它数据上传</span>
                <input type="checkbox" class="aui-checkbox center_dv1_checkbox" id="checkbox-2" onclick="setAllNo(2)" />
            </div>
            <div class="center_dv2"></div>
            <div class="center_dv3" id="photos">

            </div>
        </div>

    </div>

    <div id="footer">
        <div id="btn" onclick="upload()">上&nbsp;&nbsp;传</div>
    </div>
    </div>
</body>
<script type="text/javascript" src="../../../public/script/api.js"></script>
<script type="text/javascript" src="../../script/cbpublic.js"></script>
<script type="text/javascript" src="../../script/cbremote.js"></script>
<script type="text/javascript" src="../../../public/script/aui-popup-new.js"></script>
<script type="text/javascript" src="../../../public/script/aui-slide.js"></script>
<script type="text/javascript" src="../../../public/script/swiper.min.js"></script>
<script type="text/javascript" src="../../../public/script/diy/template.js"></script>
<script type="text/javascript" src="../../../public/script/zepto.js"></script>
<script type="text/template" id='bookList'>
    {{each datas value i}}
    <!--
    <div class="dv">
        <div class="dv-1 box" id="box_{{i+1}}">
            <div class="content" id="content_{{i+1}}">
                <p class="text padding" id="text_{{i+1}}">{{value.NAME}}</p>
                <p class="text padding">{{value.NAME}}</p>
            </div>
        </div>
        <div class="dv-5"></div>
        <div class="dv-2">已抄:{{value.YC}}</div>
        <div class="dv-3">已上传:{{value.YSC}}</div>
        <div class="dv-4">
            <input name="Fruit" type="checkbox" value="{{value.CBCH}}" class="aui-checkbox" onclick="setOthers(1)" />
        </div>
    </div>
-->
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                {{value.NAME}}
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit" type="checkbox" value="{{value.CBCH}}" class="aui-checkbox" onclick="setOthers(1)" />
            </div>
        </div>

        <div class="dv_bottom">
            <div class="dv_bottom_dv1">已&nbsp;&nbsp;抄：{{value.YC}}</div>
            <div class="dv_bottom_dv2">未&nbsp;&nbsp;抄：{{value.WC}}</div>
        </div>
    </div>
    {{/each}}
</script>
<script type="text/template" id='photolist'>
    {{each datas value i}} {{if value == 51}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                照片上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 52}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                水表位置上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 53}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                定位数据上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 54}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                导航图片上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 59}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                备忘录上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 60}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                工单图片上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{else if value == 61}}
    <div class="center_dv3_dv">
        <div class="dv_top">
            <div class="dv_top_dv1">
                日志上传
            </div>
            <div class="dv_top_dv2">
                <input name="Fruit2" type="checkbox" value="{{value}}" class="aui-checkbox" onclick="setOthers(2)" />
            </div>
        </div>
    </div>
    {{/if}} {{/each}}
</script>
<script type="text/javascript">
    var MrmBookBean = {}; //抄表册对象：{CBCH:"",CBCMC:"",YC:"",WC:"",YSC:""}。
    var MrmUserBean = {}; //抄表用户对象：{}。
    var MrmPhotoBean = {}; //抄表图片对象：{}。

    var list = []; //可以上传的抄表册。
    var checkBooksID = []; //勾选中的抄表册。

    var currentBookIndex = 0; //checkBooksID勾选中的需要上传的数据，currentBookIndex代表正在上传的抄表册的下标，
    var mPageSize = 100; //分页数。
    var mPageNo = 1; //页码。
    var errorCount = 0; //上传失败的抄表数据的条数。

    var qbUser = []; //当前要上传的抄表册里面的所有抄表数据。
    var qbJWD = []; //水表位置
    var qbPhoto = []; //当前要上传的所有抄表照片。
    var qbLocation = []; //抄表员轨迹
    var qbNavi = []; //导航图片
    var qbLog = []; //日志
    var qbmemo = []; //备忘录
    var qbWorkPhoto = []; //工单图片

    var newqbUser = []; //当前要上传的抄表册里面的所有抄表数据。
    var newqbJWD = []; //水表位置
    var newqbPhoto = []; //当前要上传的所有抄表照片。
    var newqbLocation = []; //抄表员轨迹
    var newqbNavi = []; //导航图片
    var newqbLog = []; //日志
    var newqbmemo = []; //备忘录
    var newqbWorkPhoto = []; //备忘录

    var currentList = []; //当前上传的list.
    var jwdList = []; //当前上传的JWDlist
    var photoList = []; //当前上传的抄表图片。
    var locationList = []; //当前上传的locationList
    var naviList = []; //当前上传的naviList
    var logList = []; //当前上传的logList
    var workphotoList = []; //当前上传的抄表图片。

    var otherList = []; //其他上传勾选项
    var PHOTO = 51;
    var JWD = 52;
    var LOCATION = 53;
    var NAVIPHOTO = 54;
    var MEMO = 59;
    var WORKPHOTO = 60;
    var LOG = 61;
    var step = 0;
    var OperateID = "";
    var currentCBCMC = "";
    var currentYZM = "";

    var db;
    var LoginName = "";
    apiready = function() {
        //api.parseTapmode();
        var header = $api.byId('header');
        // 实现沉浸式状态栏效果
        $api.fixStatusBar(header);
        var headerH = $api.offset(header).h;
        OperateID = $api.getStorage('cbOperatorId');
        LoginName = $api.getStorage('loginData').userName;
        $('#center').css('margin-top', '' + headerH + 'px');

        resetOtherQueryBuilder();
        initListView();
        toScrollLeft2();
    };

    function errorUserList() {
        api.openWin({
            name: 'userUploadError',
            url: './userUploadError.html',
            slidBackEnabled: false,
            animation: {
                type: "push",
                subType: "from_left",
                duration: 300
            }
        });
    }

    function toScrollLeft2() {
        var boxs = $(".box");
        for (var i = 1; i <= boxs.length; i++) {
            var box = document.getElementById("box_" + i);
            var text = document.getElementById("text_" + i);

            var scrollLeft = box.scrollLeft; //滚动条长度
            var textWidth = text.offsetWidth; //文字的长度

            if (textWidth > scrollLeft) {
                box.scrollLeft++;
            } else {
                box.scrollLeft = 0;
            }
        }
        setTimeout('toScrollLeft2()', 38);
    }

    //获取上传失败的条数
    function userErrorCount() {
        var db = api.require('db');
        var userdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select count(*) as sum from MRM_USER_BEAN where CWXX!=" " and userName="' + LoginName + '"'
        });
        if (userdata.status) {
            if (userdata.data.length > 0) {
                var sum = userdata.data[0].sum;
                if (sum > 0) {
                    $('.badge2 span').html('<span>' + sum + '</span>');
                } else {
                    //$('.badge2 span').html("0");
                    $('.badge2 span').remove();
                }
            }
        }
    }

    //获取所有可以上传的经纬度，抄表图片，导航图片，日志等数据。
    function resetOtherQueryBuilder() {
        var db = api.require('db');

        var jwddata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_METER_LOCATION_BEAN where ID=' + $api.getStorage('cbOperatorId') + ' and SFGX=0 and userName="' + LoginName + '"'
        });
        qbJWD = jwddata.data;
        newqbJWD = jwddata.data;

        var photodata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_PHOTOS_BEAN where SFSC=0 and YHBH in (select YHBH from MRM_USER_BEAN where CBBZ=1 and ZTSCCG=1 and userName="' + LoginName + '")'
        });
        qbPhoto = photodata.data;
        newqbPhoto = photodata.data;

        var locationdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_LOCATIONS_BEAN where CBY=' + $api.getStorage('cbOperatorId') + ' and SFSC=0 and userName="' + LoginName + '"'
        });
        qbLocation = locationdata.data;
        newqbLocation = locationdata.data;

        var navidata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_NAVIPHOTOS_BEAN where ID=' + $api.getStorage('cbOperatorId') + ' and SFSC=0 and userName="' + LoginName + '"'
        });
        qbNavi = navidata.data;
        newqbNavi = navidata.data;

        var logdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_LOGS_BEAN where ID=' + $api.getStorage('cbOperatorId') + ' and userName="' + LoginName + '"'
        });
        qbLog = logdata.data;
        newqbLog = logdata.data;

        var memodata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_THE_MEMO_BEAN where SFSC="0" and userName="' + LoginName + '"'
        });
        qbmemo = memodata.data;
        newqbmemo = memodata.data;

        //工单图片
        var workphotodata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_WORKORDERPHOTOS_BEAN where SFSC=0 and YHBH in (select YHBH from MRM_WORKORDER_BEAN where SFSC=1 and userName="' + LoginName + '")'
        });
        qbWorkPhoto = workphotodata.data;
        newqbWorkPhoto = workphotodata.data;

        userErrorCount();
        initOther();
    }

    //查询有上传数据的抄表册并展示
    function initListView() {
        list = [];
        var db = api.require('db');
        var bookdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_BOOKS_BEAN where userName="' + LoginName + '"'
        });
        console.log(JSON.stringify(bookdata));
        if (bookdata.status) {
            if (bookdata.data.length > 0) {
                for (var i = 0; i < bookdata.data.length; i++) {
                    var userdata_YC = db.selectSqlSync({
                        name: 'CBtest',
                        sql: 'select count(*) as YC from MRM_USER_BEAN where CBCH="' + bookdata.data[i].CBCH + '" and CBBZ=1 and CWXX=" " and userName="' + LoginName + '"'
                    });
                    var userdata_WC = db.selectSqlSync({
                        name: 'CBtest',
                        sql: 'select count(*) as WC from MRM_USER_BEAN where CBCH="' + bookdata.data[i].CBCH + '" and CBBZ=0 and userName="' + LoginName + '"'
                    });
                    var userdata_YSC = db.selectSqlSync({
                        name: 'CBtest',
                        sql: 'select count(*) as YSC from MRM_USER_BEAN where CBCH="' + bookdata.data[i].CBCH + '" and ZTSCCG=1 and CWXX=" " and userName="' + LoginName + '"'
                    });
                    if (parseInt(userdata_YC.data[0].YC) > 0 && parseInt(userdata_YC.data[0].YC) > parseInt(userdata_YSC.data[0].YSC)) {
                        list.push({
                            NAME: bookdata.data[i].CBCH + "_" + bookdata.data[i].CBCMC + "(" + bookdata.data[i].BBCYHZS + ")",
                            CBCH: bookdata.data[i].CBCH,
                            CBCMC: bookdata.data[i].CBCMC,
                            YZM: bookdata.data[i].YZM,
                            YC: userdata_YC.data[0].YC,
                            WC: userdata_WC.data[0].WC,
                            YSC: userdata_YSC.data[0].YSC
                        });
                    } else {

                    }
                }
                if (list.length > 0) {
                    var datas = {
                        datas: list
                    }

                    var str = template('bookList', datas);
                    //console.log(JSON.stringify(str));
                    $('#books div').remove();
                    $('#books').append(str);
                    fnReadyOpenWin();
                    //InitSwiper();
                } else {
                    var str = '<div style="width:100%;height:100px;text-align:center;line-height: 100px;">已抄数据已全部上传</div>';
                    $('#books div').remove();
                    $('#books').append(str);
                }

            } else {
                var str = '<div style="width:100%;height:100px;text-align:center;line-height: 100px;">已抄数据已全部上传</div>';
                $('#books div').remove();
                $('#books').append(str);
            }
        }
    }

    //判断是否有其它可上传的数据，并展示。
    function initOther() {
        var data = [];
        if (newqbPhoto != null && newqbPhoto.length > 0) {
            data.push(51);
        }
        if (newqbJWD != null && newqbJWD.length > 0) {
            data.push(52);
        }
        if (newqbLocation != null && newqbLocation.length > 0) {
            data.push(53);
        }
        if (newqbNavi != null && newqbNavi.length > 0) {
            data.push(54);
        }
        if (newqbmemo != null && newqbmemo.length > 0) {
            data.push(59);
        }
        if (newqbWorkPhoto != null && newqbWorkPhoto.length > 0) {
            data.push(60);
        }
        if (newqbLog != null && newqbLog.length > 0) {
            data.push(61);
        }
        //alert(JSON.stringify(data));
        var datas = {
            datas: data
        }

        var str = template('photolist', datas);
        //alert(JSON.stringify(str));
        //console.log(JSON.stringify(str));
        $('#photos .center_dv3_dv').remove();
        $('#photos').append(str);
        fnReadyOpenWin();
    }

    //全选
    function setAllNo(index) {
        if (index == 1) {
            var box = document.getElementById("checkbox-1");
            var loves = document.getElementsByName("Fruit");
            if (box.checked == false) {
                for (var i = 0; i < loves.length; i++) {
                    loves[i].checked = false;
                }
            } else {
                for (var i = 0; i < loves.length; i++) {
                    loves[i].checked = true;
                }
            }
        } else {
            var box = document.getElementById("checkbox-2");
            var loves = document.getElementsByName("Fruit2");
            if (box.checked == false) {
                for (var i = 0; i < loves.length; i++) {
                    loves[i].checked = false;
                }
            } else {
                for (var i = 0; i < loves.length; i++) {
                    loves[i].checked = true;
                }
            }
        }
    }

    //勾选抄表册
    function setOthers(index) {
        if (index == 1) {
            var loves = document.getElementsByName("Fruit");
            for (var i = 0; i < loves.length; i++) {
                if (loves[i].checked == false) {
                    var box = document.getElementById("checkbox-1");
                    box.checked = false;
                    return;
                }
            }
        } else {
            var loves = document.getElementsByName("Fruit2");
            for (var i = 0; i < loves.length; i++) {
                if (loves[i].checked == false) {
                    var box = document.getElementById("checkbox-2");
                    box.checked = false;
                    return;
                }
            }
        }
    }

    //上传抄表数据。
    function upload() {
        checkBooksID = [];
        otherList = [];
        var loves = document.getElementsByName("Fruit"); //获取抄表数据
        var loves2 = document.getElementsByName("Fruit2"); //获取日志数据

        for (var i = 0; i < loves.length; i++) {
            if (loves[i].checked == true) {
                checkBooksID.push(loves[i].value);
            }
        }

        for (var i = 0; i < loves2.length; i++) {
            if (loves2[i].checked == true) {
                otherList.push(new Number(loves2[i].value));
            }
        }

        if (checkBooksID != null && checkBooksID.length > 0) {
            adilog("正在上传基础数据 " + (currentBookIndex + 1) + "/" + checkBooksID.length,
                "正在上传基础数据,请稍后...");
            resetQueryBuilder(); //获取当前抄表册所有要上传的用户数据。
            continueUpdateData(); //获取当前上传的抄表数据。
        } else {
            if (otherList != null && otherList.length > 0) {
                adilog("正在上传其它数据",
                    "正在上传其它数据,请稍后...");
                uploadOthers();
            } else {
                api.toast({
                    msg: '请选择要上传的数据',
                    duration: 3000,
                    location: 'bottom'
                });
            }
        }

    }

    //获取当前抄表册所有要上传的用户数据。
    function resetQueryBuilder() {
        for (var i = 0; i < list.length; i++) {
            if (list[i].CBCH == checkBooksID[currentBookIndex]) {
                currentCBCMC = list[i].CBCMC;
                currentYZM = list[i].YZM;
                break;
            }
        }
        mPageNo = 1;
        var db = api.require('db');

        //获取当前抄表册所有要上传的用户数据。
        var userdataAll = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_USER_BEAN where CBCH="' + checkBooksID[currentBookIndex] + '" and CBBZ=1 and ZTSCCG=0 and userName="' + LoginName + '"'
        });
        qbUser = userdataAll.data;
        newqbUser = chunkArrayInGroups(userdataAll.data, mPageSize);
    }

    //获取当前上传的抄表数据。
    function continueUpdateData() {
        //获取当前上传的抄表数据。
        currentList = newqbUser[mPageNo - 1];
        //console.log(JSON.stringify(currentList));
        //alert(currentList.length);
        var records = [];
        for (var i = 0; i < currentList.length; i++) {
            if (currentList[i].SFXG == "1") {
                var user = {
                    "YHBH": currentList[i].YHBH,
                    "CBBZ": currentList[i].CBBZ,
                    "QD": currentList[i].QD,
                    "ZD": currentList[i].ZD,
                    "YL": currentList[i].YL,
                    "CBRQ": currentList[i].CBRQ,
                    "BYXZT": currentList[i].BYXZT,
                    "SJBM": currentList[i].SJBM,
                    "JD": currentList[i].CBYSZJD,
                    "WD": currentList[i].CBYSZWD,
                    "CJDZ": currentList[i].CJDZ,
                    "SFXG": currentList[i].SFXG,
                    "YHMC": currentList[i].YHMC,
                    "YHDZ": currentList[i].YHDZ,
                    "SBWZ": currentList[i].SBWZ,
                    "YDDH": currentList[i].YDDH,
                    "GDDH": currentList[i].GDDH,
                    "SBBH": currentList[i].SBBH
                }
                records.push(user);
            } else {
                var user = {
                    "YHBH": currentList[i].YHBH,
                    "CBBZ": currentList[i].CBBZ,
                    "QD": currentList[i].QD,
                    "ZD": currentList[i].ZD,
                    "YL": currentList[i].YL,
                    "CBRQ": currentList[i].CBRQ,
                    "BYXZT": currentList[i].BYXZT,
                    "SJBM": currentList[i].SJBM,
                    "JD": currentList[i].CBYSZJD,
                    "WD": currentList[i].CBYSZWD,
                    "CJDZ": currentList[i].CJDZ,
                    "SBBH": currentList[i].SBBH
                }
                records.push(user);
            }
        }
        var Parameter = {
            "ClientId": api.deviceId,
            "ClientName": api.deviceModel,
            "OperatorId": $api.getStorage('cbOperatorId'),
            "OperatorName": $api.getStorage('cbOperatorName'),
            "Required": "BookId=" + checkBooksID[currentBookIndex] + "&CheckCode=" + currentYZM + "&Rewrite=true",
            "Type": "202",
            "Records": records
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "R999",
                "Parameter": JSON.stringify(Parameter)
            })
        }
        console.log(body.body);
        fnPost('', body, 'application/json', false, function(ret, err) {
            if (ret) {
                console.log(JSON.stringify(ret));
                if (ret.Status == 0) {
                    //alert("上传成功");
                    var Data = [];
                    if (ret.Data != "" && ret.Data != " ") {
                        Data = JSON.parse(ret.Data);
                    }
                    //var Data = JSON.parse(ret.Data);
                    if (Data.length == 0) {
                        //alert("没有错误信息");
                    } else {
                        var db = api.require('db');
                        for (var i = 0; i < Data.length; i++) {
                            var ret = db.executeSqlSync({
                                name: 'CBtest',
                                sql: 'update MRM_USER_BEAN set CWXX="' + Data[i].SCSB_MESSAGE + '" where YHBH="' + Data[i].YHBH + '" and userName="' + LoginName + '"'
                            });
                        }
                    }

                    setSuccessData(currentList, Data); //修改上传标识

                    if (mPageNo == newqbUser.length) {
                        //当前本上传完
                        currentBookIndex++;
                        if (currentBookIndex + 1 <= checkBooksID.length) {
                            updateAdilogData("正在上传基础数据 " + (currentBookIndex + 1) + "/" + checkBooksID.length,
                                "正在上传基础数据,请稍后...", 0);
                            //上传其它抄表册
                            resetQueryBuilder(); //获取当前抄表册所有要上传的用户数据。
                            continueUpdateData(); //获取当前上传的抄表数据。
                        } else {
                            //抄表册上传完毕
                            uploadOthers();
                            //alert("抄表册上传完毕");
                        }
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + currentList.length, qbUser.length);
                        updateAdilogData("正在上传基础数据 " + (currentBookIndex + 1) + "/" + checkBooksID.length,
                            "正在上传基础数据,请稍后...", value);
                        mPageNo++;
                        continueUpdateData(); //获取当前上传的抄表数据。
                    }
                    insertRecords(OperateID, "上传用户数据", "上传用户数据" + currentCBCMC + "成功");
                } else {
                    insertRecords(OperateID, "上传用户数据", "上传用户数据" + currentCBCMC + "失败");
                    insertRecords(OperateID, "msg", ret.Message);
                    //alert("关闭进度条");
                    var UIActionProgress = api.require('UIActionProgress');
                    UIActionProgress.close();
                    api.toast({
                        msg: ret.Message,
                        duration: 3000,
                        location: 'bottom'
                    });
                }
            } else {
                //alert("关闭进度条");
                var UIActionProgress = api.require('UIActionProgress');
                UIActionProgress.close();
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        })
    }

    //修改上传标识
    function setSuccessData(currentList, Data) {
        var db = api.require('db');
        for (var i = 0; i < currentList.length; i++) {
            var type = false;
            for (var j = 0; j < Data.length; j++) {
                if (currentList[i].YHBH == Data[j].YHBH) {
                    type = true;
                    continue;
                }
            }
            if (!type) {
                var ret = db.executeSqlSync({
                    name: 'CBtest',
                    sql: 'update MRM_USER_BEAN set CWXX=" ", ZTSCCG=1, XGXXSC=1, SFXG=0 where YHBH="' + currentList[i].YHBH + '" and userName="' + LoginName + '"'
                });
            }
        }
        updateBookInfo(); //更新抄表册数据
    }

    //更新抄表册数据
    function updateBookInfo() {
        var db = api.require('db');
        var userdata_YC = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select count(*) as YC from MRM_USER_BEAN where CBCH="' + checkBooksID[currentBookIndex] + '" and CBBZ=1 and userName="' + LoginName + '"'
        });
        var userdata_WC = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select count(*) as WC from MRM_USER_BEAN where CBCH="' + checkBooksID[currentBookIndex] + '" and CBBZ=0 and userName="' + LoginName + '"'
        });
        var userdata_YSC = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select count(*) as YSC from MRM_USER_BEAN where CBCH="' + checkBooksID[currentBookIndex] + '" and ZTSCCG=1 and userName="' + LoginName + '"'
        });
        var ret = db.executeSqlSync({
            name: 'CBtest',
            sql: 'update MRM_BOOKS_BEAN set YC="' + userdata_YC.data[0].YC + '", WC="' + userdata_WC.data[0].WC + '", YSC="' + userdata_YSC.data[0].YSC + '" where CBCH="' + checkBooksID[currentBookIndex] + '" and userName="' + LoginName +
                '"'
        });
    }

    //上传其它数据
    function uploadOthers() {
        mPageNo = 1;
        for (var i = 0; i < otherList.length; i++) {
            if (otherList[i] == JWD) {
                if (step < JWD) {
                    updateAdilogData("正在上传水表位置", "正在上传水表位置,请稍后...", 0);
                    newqbJWD = chunkArrayInGroups(newqbJWD, mPageSize);
                    uploadJWD();
                    return;
                }
            } else if (otherList[i] == PHOTO) {
                if (step < PHOTO) {
                    updateAdilogData("正在上传照片", "正在上传照片,请稍后...", 0);
                    //qbPhoto = chunkArrayInGroups(qbPhoto, mPageSize);
                    uploadPhoto();
                    return;
                }
            } else if (otherList[i] == LOCATION) {
                if (step < LOCATION) {
                    updateAdilogData("正在上传抄表员轨迹", "正在上传抄表员轨迹,请稍后...", 0);
                    newqbLocation = chunkArrayInGroups(newqbLocation, mPageSize);
                    uploadLocation();
                    return;
                }
            } else if (otherList[i] == NAVIPHOTO) {
                if (step < NAVIPHOTO) {
                    updateAdilogData("正在上传导航图片", "正在上传导航图片,请稍后...", 0);
                    //qbNavi = chunkArrayInGroups(qbNavi, mPageSize);
                    uploadNaviPhoto();
                    return;
                }
            } else if (otherList[i] == MEMO) {
                if (step < MEMO) {
                    updateAdilogData("正在上传备忘录", "正在上传备忘录,请稍后...", 0);
                    newqbmemo = chunkArrayInGroups(newqbmemo, mPageSize);
                    uploadMemo();
                    return;
                }
            } else if (otherList[i] == WORKPHOTO) {
                if (step < WORKPHOTO) {
                    updateAdilogData("正在工单图片", "正在上传工单图片,请稍后...", 0);
                    uploadWorkPhoto();
                    return;
                }
            } else if (otherList[i] == LOG) {
                if (step < LOG) {
                    updateAdilogData("正在上传日志", "正在上传日志,请稍后...", 0);
                    newqbLog = chunkArrayInGroups(newqbLog, mPageSize);
                    uploadLog();
                    return;
                }
            }
        }

        currentBookIndex = 0;
        step = 0;
        //关闭进度条
        //alert("关闭进度条");
        var UIActionProgress = api.require('UIActionProgress');
        UIActionProgress.close();

        //重新刷新页面
        resetOtherQueryBuilder();
        initListView();
    }

    //上传水表经纬度
    function uploadJWD() {
        //获取当前上传的抄表数据。
        jwdList = newqbJWD[mPageNo - 1];
        var records = [];
        for (var i = 0; i < jwdList.length; i++) {
            var user = {
                "JD": jwdList[i].JD,
                "WD": jwdList[i].WD,
                "YHBH": jwdList[i].YHBH
            }
            records.push(user);
        }
        var Parameter = {
            "ClientId": api.deviceId,
            "ClientName": api.deviceModel,
            "OperatorId": $api.getStorage('cbOperatorId'),
            "OperatorName": $api.getStorage('cbOperatorName'),
            "Required": "",
            "Type": "221",
            "Records": records
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "R999",
                "Parameter": JSON.stringify(Parameter)
            })
        }
        fnPost('', body, 'application/json', false, function(ret, err) {
            if (ret) {
                if (ret.Status == 0) {
                    //上传成功
                    var db = api.require('db');
                    for (var i = 0; i < jwdList.length; i++) {
                        var ret = db.executeSqlSync({
                            name: 'CBtest',
                            sql: 'update MRM_METER_LOCATION_BEAN set SFGX=1 where _id="' + jwdList[i]._id + '" and userName="' + LoginName + '"'
                        });
                    }

                    if (mPageNo == newqbJWD.length) {
                        //已上传完
                        step = JWD;
                        insertRecords(OperateID, "抄表定位", "上传定位数据成功");
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + jwdList.length, qbJWD.length);
                        updateAdilogData("正在上传水表位置", "正在上传水表位置,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadJWD();
                    }
                } else {
                    //上传失败
                    //alert(JSON.stringify(ret.Message));
                    insertRecords(OperateID, "抄表定位", "上传定位数据失败");
                    insertRecords(OperateID, "msg", ret.Message);
                    if (mPageNo == newqbJWD.length) {
                        //已上传完
                        step = JWD;
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + jwdList.length, qbJWD.length);
                        updateAdilogData("正在上传水表位置", "正在上传水表位置,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadJWD();
                    }
                }
            } else {
                api.alert({
                    msg: JSON.stringify(err)
                });
            }
        })
    }

    //判断照片文件是否存在 2020-05-22 zlx
    function isExistFnc(path) {
        var fs = api.require('fs');
        fs.exist({
            path: path
        }, function(ret, err) {
            if (ret.exist) { //文件不存在
                return true;
            } else {
                return false;
            }
        });
    }

    //上传照片
    function uploadPhoto() {
        //获取当前上传的抄表数据。
        photoList = newqbPhoto[mPageNo - 1];

        //判断照片文件是否存在 2020-05-22 zlx
        var fs = api.require('fs');
        fs.exist({
            path: photoList.ZPLJ
        }, function(ret, err) {
            if (ret.exist) {
                //文件存在
                var Parameter;
                if (photoList.NotLoction == 0) {
                    Parameter = {
                        "ClientId": api.deviceId,
                        "ClientName": api.deviceModel,
                        "OperatorId": $api.getStorage('cbOperatorId'),
                        "OperatorName": $api.getStorage('cbOperatorName'),
                        "Yhbh": photoList.YHBH,
                        "PhotoName": photoList.ZPMC,
                        "PhotoType": "1",
                        "Longitude": photoList.JD,
                        "Latitude": photoList.WD,
                        "OrderNo": "",
                        "Errtype": "",
                        "Remark": "",
                        "Type": "302",
                        "PhotoInfo": ""
                    };
                } else if (photoList.NotLoction == 1) {
                    Parameter = {
                        "ClientId": api.deviceId,
                        "ClientName": api.deviceModel,
                        "OperatorId": $api.getStorage('cbOperatorId'),
                        "OperatorName": $api.getStorage('cbOperatorName'),
                        "Yhbh": photoList.YHBH,
                        "PhotoName": photoList.ZPMC,
                        "PhotoType": "4",
                        "Longitude": photoList.JD,
                        "Latitude": photoList.WD,
                        "OrderNo": "",
                        "Errtype": "",
                        "Remark": "",
                        "Type": "302",
                        "PhotoInfo": ""
                    };
                }

                var FileUrlArr = [];
                FileUrlArr.push(photoList.ZPLJ);
                api.ajax({
                    url: $api.getStorage('cbapipath') + '/api/WaterMeters/Info',
                    method: 'post',
                    timeout: 60,
                    data: {
                        values: {
                            Method: 'R999',
                            UserName: $api.getStorage('cbOperatorName'), //"01012"
                            Password: $api.getStorage('cbPassword'), // "g6OuZomFp3E="
                            SerialNo: dataTime(),
                            KeyCode: '', //营业
                            Parameter: JSON.stringify(Parameter)
                        },
                        files: {
                            file: FileUrlArr
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        if (ret.Status == 0) {
                            //上传成功
                            var db = api.require('db');
                            var ret = db.executeSqlSync({
                                name: 'CBtest',
                                sql: 'update MRM_PHOTOS_BEAN set SFSC="1" where _id="' + photoList._id + '" and userName="' + LoginName + '"'
                            });

                            if (mPageNo == newqbPhoto.length) {
                                //已上传完
                                step = PHOTO;
                                insertRecords(OperateID, "抄表照片", "上传抄表照片成功");
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbPhoto.length);
                                updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadPhoto();
                            }
                        } else {
                            //上传失败
                            //alert(JSON.stringify(ret.Message));
                            insertRecords(OperateID, "抄表照片", "上传抄表照片失败");
                            insertRecords(OperateID, "msg", ret.Message);
                            if (mPageNo == newqbPhoto.length) {
                                //已上传完
                                step = PHOTO;
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbPhoto.length);
                                updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadPhoto();
                            }
                        }
                    } else {
                        var UIActionProgress = api.require('UIActionProgress');
                        UIActionProgress.close();
                        api.alert({
                            msg: JSON.stringify(err.msg)
                        });
                    }
                });


                // var PhotoInfo = "";
                // var trans = api.require('trans');
                // trans.decodeImgToBase64({
                //     imgPath: photoList.ZPLJ
                // }, function(ret, err) {
                //     if (ret.status) {
                //         //alert(JSON.stringify(ret));
                //         PhotoInfo = ret.base64Str;
                //         var Parameter;
                //         if (photoList.NotLoction == 0) {
                //             Parameter = {
                //                 "ClientId": api.deviceId,
                //                 "ClientName": api.deviceModel,
                //                 "OperatorId": $api.getStorage('cbOperatorId'),
                //                 "OperatorName": $api.getStorage('cbOperatorName'),
                //                 "Yhbh": photoList.YHBH,
                //                 "PhotoName": photoList.ZPMC,
                //                 "PhotoType": "1",
                //                 "Longitude": photoList.JD,
                //                 "Latitude": photoList.WD,
                //                 "OrderNo": "",
                //                 "Errtype": "",
                //                 "Remark": "",
                //                 "Type": "302",
                //                 "PhotoInfo": PhotoInfo
                //             };
                //         } else if (photoList.NotLoction == 1) {
                //             Parameter = {
                //                 "ClientId": api.deviceId,
                //                 "ClientName": api.deviceModel,
                //                 "OperatorId": $api.getStorage('cbOperatorId'),
                //                 "OperatorName": $api.getStorage('cbOperatorName'),
                //                 "Yhbh": photoList.YHBH,
                //                 "PhotoName": photoList.ZPMC,
                //                 "PhotoType": "4",
                //                 "Longitude": photoList.JD,
                //                 "Latitude": photoList.WD,
                //                 "OrderNo": "",
                //                 "Errtype": "",
                //                 "Remark": "",
                //                 "Type": "302",
                //                 "PhotoInfo": PhotoInfo
                //             };
                //         }
                //
                //         var body = {
                //             body: JSON.stringify({
                //                 "UserName": $api.getStorage('cbOperatorName'),
                //                 "Password": $api.getStorage('cbPassword'),
                //                 "SerialNo": dataTime(),
                //                 "Method": "R999",
                //                 "Parameter": JSON.stringify(Parameter)
                //             })
                //         }
                //         //console.log(body.body);
                //         fnPost('', body, 'application/json', false, function(ret, err) {
                //             //alert(JSON.stringify(ret));
                //             if (ret) {
                //                 if (ret.Status == 0) {
                //                     //上传成功
                //                     var db = api.require('db');
                //                     /*
                //                     for (var i = 0; i < photoList.length; i++) {
                //                         var ret = db.executeSqlSync({
                //                             name: 'mrm',
                //                             sql: 'update MRM_PHOTOS_BEAN set SFSC=1 where _id="' + photoList._id + '"'
                //                         });
                //                     }
                //                     */
                //                     var ret = db.executeSqlSync({
                //                         name: 'CBtest',
                //                         sql: 'update MRM_PHOTOS_BEAN set SFSC="1" where _id="' + photoList._id + '" and userName="' + LoginName + '"'
                //                     });
                //
                //                     if (mPageNo == newqbPhoto.length) {
                //                         //已上传完
                //                         step = PHOTO;
                //                         insertRecords(OperateID, "抄表照片", "上传抄表照片成功");
                //                         uploadOthers();
                //                     } else {
                //                         var value = GetPercent((mPageNo - 1) + 1, qbPhoto.length);
                //                         updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                //                         //未上传完
                //                         mPageNo++;
                //                         uploadPhoto();
                //                     }
                //                 } else {
                //                     //上传失败
                //                     //alert(JSON.stringify(ret.Message));
                //                     insertRecords(OperateID, "抄表照片", "上传抄表照片失败");
                //                     insertRecords(OperateID, "msg", ret.Message);
                //                     if (mPageNo == newqbPhoto.length) {
                //                         //已上传完
                //                         step = PHOTO;
                //                         uploadOthers();
                //                     } else {
                //                         var value = GetPercent((mPageNo - 1) + 1, qbPhoto.length);
                //                         updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                //                         //未上传完
                //                         mPageNo++;
                //                         uploadPhoto();
                //                     }
                //                 }
                //             } else {
                //                 var UIActionProgress = api.require('UIActionProgress');
                //                 UIActionProgress.close();
                //                 api.alert({
                //                     msg: JSON.stringify(err.msg)
                //                 });
                //             }
                //         })
                //     } else {
                //         alert(JSON.stringify(err.msg));
                //         var UIActionProgress = api.require('UIActionProgress');
                //         UIActionProgress.close();
                //     }
                // });
            } else {
                //文件不存在
                var db = api.require('db');
                var result = db.executeSqlSync({
                    name: 'CBtest',
                    sql: 'DELETE FROM MRM_PHOTOS_BEAN where _id="' + photoList._id + '" and userName="' + LoginName + '"'
                });

                if (mPageNo == newqbPhoto.length) {
                    //已上传完
                    step = PHOTO;
                    insertRecords(OperateID, "抄表照片", "上传抄表照片成功");
                    uploadOthers();
                } else {
                    var value = GetPercent((mPageNo - 1) + 1, qbPhoto.length);
                    updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                    //未上传完
                    mPageNo++;
                    uploadPhoto();
                }
            }
        });
    }

    //上传工单图片
    function uploadWorkPhoto() {
        //获取当前上传的抄表数据。
        workphotoList = newqbWorkPhoto[mPageNo - 1];
        var FileUrlArr = [];

        var TypeId = ".jpg";
        var filePath = workphotoList.ZPLJ;
        var Remark = workphotoList.REMARK;
        FileUrlArr.push(workphotoList.ZPLJ);

        var db = api.require('db');
        var ret = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_WORKORDER_BEAN where YHBH="' + workphotoList.YHBH + '" and userName="' + LoginName + '"'
        });
        if (ret.status) {
            if (ret.data.length > 0) {
                api.ajax({
                    url: $api.getStorage('cbapipath') + '/api/WaterMeters/Info',
                    method: 'post',
                    timeout: 60,
                    data: {
                        values: {
                            Method: 'MMS100',
                            UserName: $api.getStorage('cbOperatorName'), //"01012"
                            Password: $api.getStorage('cbPassword'), // "g6OuZomFp3E="
                            SerialNo: dataTime(),
                            KeyCode: '', //营业
                            Parameter: '{"ReqCode": "' + ret.data[0].LCBH + '","TypeId": "' + TypeId + '","filePath": "' + filePath +
                                '","Remark": "","Title": "","AttachmentType": "1"}'
                        },
                        files: {
                            file: FileUrlArr
                        }
                    }
                }, function(ret, err) {
                    if (ret) {
                        if (ret.Status == 0) {
                            var db = api.require('db');
                            var workOrderData = db.executeSqlSync({
                                name: 'CBtest',
                                sql: 'update MRM_WORKORDERPHOTOS_BEAN set SFSC="1" where YHBH="' + workphotoList.YHBH + '" and userName="' + LoginName + '"'
                            });

                            if (mPageNo == newqbWorkPhoto.length) {
                                //已上传完
                                step = WORKPHOTO;
                                insertRecords(OperateID, "工单照片", "上传工单照片成功");
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbWorkPhoto.length);
                                updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadWorkPhoto();
                            }
                        } else {
                            //上传失败
                            // api.toast({
                            //     msg: ret.Message,
                            //     duration: 3000,
                            //     location: 'bottom'
                            // });
                            insertRecords(OperateID, "工单照片", "上传工单照片失败");
                            insertRecords(OperateID, "msg", ret.Message);
                            if (mPageNo == newqbWorkPhoto.length) {
                                //已上传完
                                step = WORKPHOTO;
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbWorkPhoto.length);
                                updateAdilogData("正在上传照片", "正在上传照片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadWorkPhoto();
                            }
                        }
                    } else {
                        var UIActionProgress = api.require('UIActionProgress');
                        UIActionProgress.close();
                        api.alert({
                            msg: JSON.stringify(err.msg)
                        });
                    }
                });
            }
        }
    }

    //上传抄表员轨迹
    function uploadLocation() {
        //获取当前上传的抄表数据。
        locationList = newqbLocation[mPageNo - 1];
        var records = [];
        for (var i = 0; i < locationList.length; i++) {
            var user = {
                "CBY": locationList[i].CBY,
                "JD": locationList[i].JD,
                "WD": locationList[i].WD,
                "DZ": locationList[i].DZ,
                "CJSJ": locationList[i].CJSJ,
                "CBCH": "",
                "YHBH": ""
            }
            records.push(user);
        }
        var Parameter = {
            "ClientId": api.deviceId,
            "ClientName": api.deviceModel,
            "OperatorId": $api.getStorage('cbOperatorId'),
            "OperatorName": $api.getStorage('cbOperatorName'),
            "Required": "",
            "Type": "205",
            "Records": records
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "R999",
                "Parameter": JSON.stringify(Parameter)
            })
        }
        fnPost('', body, 'application/json', false, function(ret, err) {
            if (ret) {
                if (ret.Status == 0) {
                    //上传成功
                    var db = api.require('db');
                    for (var i = 0; i < locationList.length; i++) {
                        var ret = db.executeSqlSync({
                            name: 'CBtest',
                            sql: 'delete from MRM_LOCATIONS_BEAN where _id="' + locationList[i]._id + '" and userName="' + LoginName + '"'
                        });
                    }

                    if (mPageNo == newqbLocation.length) {
                        //已上传完
                        step = LOCATION;
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + locationList.length, qbLocation.length);
                        updateAdilogData("正在上传抄表员轨迹", "正在上传抄表员轨迹,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadLocation();
                    }
                } else {
                    //上传失败
                    //alert(JSON.stringify(ret.Message));
                    insertRecords(OperateID, "抄表员轨迹", "上传抄表员轨迹失败");
                    insertRecords(OperateID, "msg", ret.Message);
                    if (mPageNo == newqbLocation.length) {
                        //已上传完
                        step = LOCATION;
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + locationList.length, qbLocation.length);
                        updateAdilogData("正在上传抄表员轨迹", "正在上传抄表员轨迹,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadLocation();
                    }
                }
            } else {
                var UIActionProgress = api.require('UIActionProgress');
                UIActionProgress.close();
                api.alert({
                    msg: JSON.stringify(err.msg)
                });
            }
        })
    }

    //上传导航图片
    function uploadNaviPhoto() {
        //获取当前上传的抄表数据。
        naviList = newqbNavi[mPageNo - 1];
        var PhotoInfo = "";
        var trans = api.require('trans');
        trans.decodeImgToBase64({
            imgPath: naviList.ZPLJ
        }, function(ret, err) {
            if (ret.status) {
                //alert(JSON.stringify(ret));
                PhotoInfo = ret.base64Str;
                var Parameter = {
                    "ClientId": api.deviceId,
                    "ClientName": api.deviceModel,
                    "OperatorId": $api.getStorage('cbOperatorId'),
                    "OperatorName": $api.getStorage('cbOperatorName'),
                    "Yhbh": naviList.YHBH,
                    "PhotoName": naviList.ZPMC,
                    "PhotoType": naviList.ZPLX,
                    "Longitude": naviList.ZPJD,
                    "Latitude": naviList.ZPWD,
                    "OrderNo": naviList.ORDERNO,
                    "Errtype": "",
                    "Remark": naviList.REMARK,
                    "Type": "302",
                    "PhotoInfo": PhotoInfo
                };
                var body = {
                    body: JSON.stringify({
                        "UserName": $api.getStorage('cbOperatorName'),
                        "Password": $api.getStorage('cbPassword'),
                        "SerialNo": dataTime(),
                        "Method": "R999",
                        "Parameter": JSON.stringify(Parameter)
                    })
                }
                fnPost('', body, 'application/json', false, function(ret, err) {
                    if (ret) {
                        if (ret.Status == 0) {
                            //上传成功
                            var db = api.require('db');
                            /*
                            for (var i = 0; i < naviList.length; i++) {
                                var ret = db.executeSqlSync({
                                    name: 'mrm',
                                    sql: 'update MRM_NAVIPHOTOS_BEAN set SFSC=1 where _id="' + naviList[i]._id + '"'
                                });
                            }
                            */
                            var ret = db.executeSqlSync({
                                name: 'CBtest',
                                sql: 'update MRM_NAVIPHOTOS_BEAN set SFSC=1 where _id="' + naviList._id + '" and userName="' + LoginName + '"'
                            });

                            if (mPageNo == newqbNavi.length) {
                                //已上传完
                                step = NAVIPHOTO;
                                insertRecords(OperateID, "导航图片", "上传导航图片成功");
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbNavi.length);
                                updateAdilogData("正在上传导航图片", "正在上传导航图片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadNaviPhoto();
                            }
                        } else {
                            //上传失败
                            //alert(JSON.stringify(ret.Message));
                            insertRecords(OperateID, "导航图片", "上传导航图片失败");
                            insertRecords(OperateID, "msg", ret.Message);
                            if (mPageNo == newqbNavi.length) {
                                //已上传完
                                step = NAVIPHOTO;
                                uploadOthers();
                            } else {
                                var value = GetPercent((mPageNo - 1) + 1, qbNavi.length);
                                updateAdilogData("正在上传导航图片", "正在上传导航图片,请稍后...", value);
                                //未上传完
                                mPageNo++;
                                uploadNaviPhoto();
                            }
                        }
                    } else {
                        var UIActionProgress = api.require('UIActionProgress');
                        UIActionProgress.close();
                        api.alert({
                            msg: JSON.stringify(err.msg)
                        });
                    }
                })
            }
        });
    }

    //上传日志
    function uploadLog() {
        //获取当前上传的抄表数据。
        //logList = newqbLog[mPageNo - 1];

        var db = api.require('db');
        var logdata = db.selectSqlSync({
            name: 'CBtest',
            sql: 'select * from MRM_LOGS_BEAN where ID=' + $api.getStorage('cbOperatorId') + ' and userName="' + LoginName + '"'
        });
        logList = logdata.data;

        var records = [];
        for (var i = 0; i < logList.length; i++) {
            var user = {
                "CBY": logList[i].ID,
                "EVENT": logList[i].EVENT,
                "TIME": logList[i].TIME,
                "INFO": logList[i].INFORMATION
            }
            records.push(user);
        }
        var Parameter = {
            "ClientId": api.deviceId,
            "ClientName": api.deviceModel,
            "OperatorId": $api.getStorage('cbOperatorId'),
            "OperatorName": $api.getStorage('cbOperatorName'),
            "Required": "CheckCode=12345",
            "Type": "203",
            "Records": records
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "R999",
                "Parameter": JSON.stringify(Parameter)
            })
        }
        fnPost('', body, 'application/json', false, function(ret, err) {
            if (ret) {
                if (ret.Status == 0) {
                    //上传成功
                    var db = api.require('db');
                    for (var i = 0; i < logList.length; i++) {
                        var ret = db.executeSqlSync({
                            name: 'CBtest',
                            sql: 'delete from MRM_LOGS_BEAN where _id="' + logList[i]._id + '" and userName="' + LoginName + '"'
                        });
                    }

                    if (mPageNo == newqbLog.length) {
                        //已上传完
                        step = LOG;
                        uploadOthers();
                        //insertRecords(OperateID, "正常上传日志", "成功");
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + logList.length, qbLog.length);
                        updateAdilogData("正在上传日志", "正在上传日志,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadLog();
                    }
                } else {
                    //上传失败
                    //alert(JSON.stringify(ret.Message));
                    insertRecords(OperateID, "正常上传日志", "失败");
                    insertRecords(OperateID, "msg", ret.Message);
                    if (mPageNo == newqbLog.length) {
                        //已上传完
                        step = LOG;
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + logList.length, qbLog.length);

                        updateAdilogData("正在上传日志", "正在上传日志,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadLog();
                    }
                }
            } else {
                var UIActionProgress = api.require('UIActionProgress');
                UIActionProgress.close();
                api.alert({
                    msg: JSON.stringify(err.msg)
                });
            }
        })
    }

    //上传备忘录
    function uploadMemo() {
        //获取当前上传的抄表数据。
        memoList = newqbmemo[mPageNo - 1];
        var records = [];
        for (var i = 0; i < memoList.length; i++) {
            var user = {
                "YHBH": memoList[i].YHBH,
                "CONTENT": memoList[i].REMARK,
                "TYPE": "3",
                "REQUENCY": memoList[i].TXLX,
                "TIME": memoList[i].TXSJ
            }
            records.push(user);
        }
        var Parameter = {
            "ClientId": api.deviceId,
            "ClientName": api.deviceModel,
            "OperatorId": $api.getStorage('cbOperatorId'),
            "OperatorName": $api.getStorage('cbOperatorName'),
            "Required": "CheckCode=12345",
            "Type": "237",
            "Records": records
        };
        var body = {
            body: JSON.stringify({
                "UserName": $api.getStorage('cbOperatorName'),
                "Password": $api.getStorage('cbPassword'),
                "SerialNo": dataTime(),
                "Method": "R999",
                "Parameter": JSON.stringify(Parameter)
            })
        }
        fnPost('', body, 'application/json', false, function(ret, err) {
            if (ret) {
                if (ret.Status == 0) {
                    //上传成功
                    var db = api.require('db');
                    for (var i = 0; i < memoList.length; i++) {
                        var ret = db.executeSqlSync({
                            name: 'CBtest',
                            sql: 'update MRM_THE_MEMO_BEAN set SFSC="1" where _id="' + memoList[i]._id + '" and userName="' + LoginName + '"'
                        });
                    }

                    if (mPageNo == newqbmemo.length) {
                        //已上传完
                        step = MEMO;
                        uploadOthers();
                        //insertRecords(OperateID, "正常上传日志", "成功");
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + memoList.length, qbmemo.length);
                        updateAdilogData("正在上传备忘录", "正在上传备忘录,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadMemo();
                    }
                } else {
                    //上传失败
                    //alert(JSON.stringify(ret.Message));
                    insertRecords(OperateID, "正常上传备忘录", "失败");
                    insertRecords(OperateID, "msg", ret.Message);
                    if (mPageNo == newqbmemo.length) {
                        //已上传完
                        step = MEMO;
                        uploadOthers();
                    } else {
                        var value = GetPercent((mPageNo - 1) * mPageSize + memoList.length, qbmemo.length);

                        updateAdilogData("正常上传备忘录", "正常上传备忘录,请稍后...", value);
                        //未上传完
                        mPageNo++;
                        uploadLog();
                    }
                }
            } else {
                var UIActionProgress = api.require('UIActionProgress');
                UIActionProgress.close();
                api.alert({
                    msg: JSON.stringify(err.msg)
                });
            }
        })
    }

    //将数据分页arr代表数组，size代表每页条数
    function chunkArrayInGroups(arr, size) {
        // Break it up.
        var length = arr.length;
        var newArr = [];
        var i = Math.ceil(length / size * 1.0);
        var j = 0;
        while (j < i) {
            var spare = length - j * size >= size ? size : length - j * size;
            var temp = arr.slice(j * size, j * size + spare);
            newArr.push(temp);
            j++;
        }
        return newArr;
    }

    //获取百分比
    function GetPercent(num, total) {
        num = parseFloat(num);
        total = parseFloat(total);
        if (isNaN(num) || isNaN(total)) {
            return "-";
        }

        return total <= 0 ? "0" : (Math.round(num / total * 100) / 100.00);
    }

    function adilog(title, msg) {
        var UIActionProgress = api.require('UIActionProgress');
        UIActionProgress.open({
            maskBg: 'rgba(0,0,0,0.5)',
            styles: {
                h: 150,
                bg: '#fff',
                title: {
                    size: 18,
                    color: '#000',
                    marginT: 10
                },
                msg: {
                    size: 15,
                    color: '#000',
                    marginT: 10
                },
                lable: {
                    size: 15,
                    color: '#696969',
                    marginB: 5
                },
                progressBar: {
                    size: 2,
                    normal: '#000',
                    active: '#4876FF',
                    marginB: 35,
                    margin: 5
                }
            },
            data: {
                title: title,
                msg: msg,
                value: 0
            }
        }, function(ret) {
            // api.alert({
            //     msg: JSON.stringify(ret)
            // });
        });
    }

    function updateAdilogData(title, msg, value) {
        var UIActionProgress = api.require('UIActionProgress');
        UIActionProgress.setData({
            data: {
                title: title,
                msg: msg,
                value: value * 100
            }
        });
    }

    function insertRecords(id, event, information) {
        var date = new Date(); //实例一个时间对象；
        var year = getTime("year"); //获取系统的年；
        var month = getTime("month"); //获取系统月份，由于月份是从0开始计算，所以要加1
        var day = getTime("day"); //获取系统日
        var hour = getTime("hour"); //获取系统时间
        var minute = getTime("minute"); //分
        var second = getTime("second"); //秒
        var time = year + "-" + month + "-" + day + " " + hour + ":" + minute;
        var db = api.require('db');
        var ret = db.executeSqlSync({
            name: 'CBtest',
            sql: "INSERT INTO MRM_LOGS_BEAN " +
                "(userName, ID, EVENT, INFORMATION, TIME) VALUES " +
                "('" + LoginName +
                "', '" + id +
                "', '" + event +
                "', '" + information +
                "', '" + time + "')"
        });
    }

    function getTime(type) {
        var date = new Date()
        var time = null
        switch (type) {
            case 'year':
                time = date.getFullYear().toString()
                break
            case 'month':
                time = date.getMonth() + 1
                time = time.toString().length === 2 ? time : ('0' + time)
                break
            case 'day':
                time = date.getDate()
                time = time.toString().length === 2 ? time : ('0' + time)
                break
            case 'hour':
                time = date.getHours()
                time = time.toString().length === 2 ? time : ('0' + time)
                break
            case 'minute':
                time = date.getMinutes()
                time = time.toString().length === 2 ? time : ('0' + time)
                break
            case 'second':
                time = date.getSeconds()
                time = time.toString().length === 2 ? time : ('0' + time)
                break
        }
        return time
    }

    var actionList = {
        'back': function() {
            api.closeWin();
        },
        'select': function() {
            api.openWin({
                name: 'userUploadError',
                url: './userUploadError.html',
                slidBackEnabled: false,
                animation: {
                    type: "push",
                    subType: "from_left",
                    duration: 300
                }
            });
        }
    }
</script>

</html>
